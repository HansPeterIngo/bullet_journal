# frozen_string_literal: true

require 'prawn'
require 'holidays'

module BulletJournal
  ##
  # Generates printable calendar sheets for a bullet journal.
  #
  class Calendar
    include Prawn::View
    include Colors
    #include DuplexPrinting

    def initialize(start_date, end_date, output_file)
      initialize_pdf_document
      initialize_dates(start_date,end_date)
      @tasks = Tasks.for(start_date..end_date)
      @output_file = output_file
    end

    private

    def initialize_pdf_document
      @document = Prawn::Document.new(page_layout: :portrait, page_size: 'A5')
      @page_width = bounds.width
      @page_height = bounds.height
      initialize_font
    end

    def initialize_font
      font_families.update(Fonts::FONTS)
      font 'Roboto'
      font_size 12
    end

    def initialize_dates(start_date, end_date)
      @start_date = start_date - 4
      @end_date = end_date
      @dates = ((start_date)..end_date).to_a
      ensure_complete_fortnight
      reorder_dates_for_duplex_printing
    end

    def ensure_complete_fortnight
      push_dates = 14 - (@dates.length % 14)
      unless push_dates == 0
        dates = (@end_date + 1)..(@end_date + push_dates)
        @dates.push(*dates)
      end
    end

    def reorder_dates_for_duplex_printing
      reorder_dates = []
      @dates.each_slice(14) do |slice|
        reorder_dates.push(slice[4..-1])
        reorder_dates.push(slice[0..3])
      end
      @dates = reorder_dates
    end

    def width
      bounds.width
    end

    def height
      bounds.height
    end
  end
end

=begin

      setup_page(true, @start_date)

      page = 0
      num = 0

      @reorder_dates.each do |date|
        next if [0, 6].include?(date.wday)

        if num % 5 == (page.even? ? 3 : 2)
          page += 1
          num = 0
          start_new_page
          setup_page(page.even?, date)
        end

        num += 1
      end
      save_as output
    end

    private


    def header(page_even, date)
      stroke_color GRAY
      stroke_horizontal_line 0, @width, at: HEADER_POSITION

      stroke_color BLACK
      if page_even
        text_box "#{date.year} #{date.monthname}", at: [0, HEADER_POSITION + 20], width: @width, align: :left, style: :bold
      else
        text_box "#{date.monthname} #{date.year}", at: [0, HEADER_POSITION + 20], width: @width, align: :right, style: :bold
      end
    end

    def setup_page(page_even, date)
      stroke_axis

      horizontal_split HEADER_POSITION do
        top do
          header page_even, date
        end
        bottom do
          dotted_background
        end
      end

      month_width = 80
      month_height = 50

      if page_even
        padding_x = 0
        padding_y = 5
        translate(@width - month_width, @height - padding_y) do
          print_month(date, date, month_width, month_height)
        end

        5.times do |i|
          current_date = date + i
          h = HEADER_POSITION / 5
          offset = i * h
          bounding_box([padding_x, HEADER_POSITION - padding_y - offset], width: @width - padding_x * 2, height: h) do
            indent 5 do
              feiertag = ''
              feiertag = ' Feiertag' if current_date.holiday?(:de_he)
              formatted_text_box [{ text: (current_date.strftime '%d').to_s, styles: [:bold] },
                                  { text: " #{current_date.dayname}", size: 8 },
                                  { text: feiertag, size: 6, styles: [:italic] }]
            end

            create_grid 3, 4 do |x, y|
              index = (y + (2 - x) * 4)
              if @tasks[current_date]
todo = @tasks[current_date][index]
                if todo
                  stroke_circle [0, 19], 3
                  indent 15 do
                    text todo
                  end
                end
              end
            end

            stroke_color GRAY
            stroke_horizontal_line 0, bounds.width, at: 5 if i != 4
            # stroke_bounds
          end
        end
      else
        stroke_color GRAY
        stroke_horizontal_line 0, @width, at: @height / 2
        stroke_vertical_line @height / 4, @height / 2, at: @width / 2
        stroke_horizontal_line 0, @width, at: @height / 4

        stroke_color BLACK
        font_size = 8
        align = :right
        padding_x = 10
        padding_y = 5
        x = @width - @width / 3 - padding_x
        width = @width / 3

        text_box 'Notizen', at: [x, HEADER_POSITION - padding_y], width: width, align: align, size: font_size
        text_box 'Sonstige Aufgaben', at: [x, @height / 4 - padding_y], width: width, align: align, size: font_size

        text_box 'Ziel der Woche', at: [padding_x, @height / 2 - padding_y], width: width, align: :left, size: font_size
        text_box 'Hightlight der Woche', at: [x, @height / 2 - padding_y], width: width, align: align, size: font_size

        translate(0, @height - padding_y) do
          print_month(date >> 1, date, month_width, month_height)
        end
      end
    end
  end
=end
